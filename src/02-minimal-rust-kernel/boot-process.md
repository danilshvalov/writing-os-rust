
# Процесс загрузки

Когда вы включаете ваш компьютер, начинается выполнение кода, зашитого в [постоянной памяти][ROM] материнской платы. На архитектуре x86 существует два стандарта прошивок: "Basic Input/Output System" (**[BIOS]**) и более новый "Unified Extensible Firmware Interface" (**[UEFI]**). Стандарт BIOS считается устаревшим, но простым и хорошо поддерживается на x86 машинах с 1980-х годов. UEFI, напротив, более современный и содержит гораздо больше возможностей, а потому и более сложен в настройке. В этой книге мы рассмотрим именно BIOS.

## Загрузка BIOS

Почти все x86 системы имеют поддержку BIOS, в том числе и новые машины на UEFI. Это здорово, потому что мы можем использовать одну и ту же логику загрузки на всех устройствах, как на современных, так и на компьютерах прошлого столетия. Но у этого решения есть свой недостаток. При загрузке BIOS процессор переходит в 16-битный режим совместимости, также известный как [real mode], благодаря чему и работают все старые загрузчики, написанные еще в 1980-х.

Но давайте начнем с самого начала:

Когда вы включаете компьютер, он загружает BIOS со специального флеш-накопителя, расположенного на материнской плате. BIOS запускает [процедуры самопроверки][power-on self-test], обнаруживает доступное количество оперативной памяти, инициализирует оборудование, а затем ищет загрузочные диски. Если загрузочный диск найден, то управление передается _загрузчику_, который представляет собой исполняемый файл, хранящийся на первых 512 байтах в начале диска. Большинство загрузчиков имеют размер более 512 байт, поэтому загрузчики обычно разделяют на две части: первую маленькую, которая умещается в 512 байт, и вторую, которая впоследствии загружается первой частью.

Загрузчик должен определить расположение образа ядра на диске и загрузить его в память. Также необходимо переключить режим работы процессора с 16-битного [real mode] сначала в 32-битный [protected mode], а затем в 64-битный [long mode], где 64-битные регистры и вся основная память будет доступна. Это его третья задача - запросить определенную информацию из BIOS, например memory map, и передать ее ядру ОС.

Написание загрузчика выходит за рамки этой книги, поэтому мы не будем рассматривать создание загрузчика, а вместо этого предоставим эту работу крейту [bootimage], который добавит загрузчик к нашему ядру ОС.

[ROM]: https://en.wikipedia.org/wiki/Read-only_memory
[power-on self-test]: https://en.wikipedia.org/wiki/Power-on_self-test
[BIOS]: https://en.wikipedia.org/wiki/BIOS
[UEFI]: https://en.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface
[real mode]: https://en.wikipedia.org/wiki/Real_mode
[protected mode]: https://en.wikipedia.org/wiki/Protected_mode
[long mode]: https://en.wikipedia.org/wiki/Long_mode
[bootimage]: https://github.com/rust-osdev/bootimage
